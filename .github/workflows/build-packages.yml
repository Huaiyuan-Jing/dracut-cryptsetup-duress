name: Build and Release
on:
  push:
    tags:
      - 'v*'
jobs:
  build-rpm:
    runs-on: ubuntu-latest
    container: fedora:latest
    steps:
      - name: Install Build Tools
        run: dnf install -y git rpm-build rpmdevtools tar

      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Prepare Version
        id: get_version
        run: |
          echo "VERSION=${GITHUB_REF#refs/tags/v}" >> $GITHUB_ENV

      - name: Build RPM
        run: |
          mkdir -p ~/rpmbuild/{SOURCES,SPECS}
          
          sed -i "s/^Version:.*/Version:        ${{ env.VERSION }}/" *.spec
          
          tar czf ~/rpmbuild/SOURCES/dracut-cryptsetup-duress-${{ env.VERSION }}.tar.gz --exclude=.git .
          
          rpmbuild -bb *.spec
          
          mv ~/rpmbuild/RPMS/noarch/*.rpm .

      - name: Upload RPM Artifact
        uses: actions/upload-artifact@v4
        with:
          name: rpm-package
          path: ./*.rpm

  build-deb:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Install Build Tools
        run: sudo apt-get update && sudo apt-get install -y debhelper devscripts build-essential

      - name: Prepare Version
        run: echo "VERSION=${GITHUB_REF#refs/tags/v}" >> $GITHUB_ENV

      - name: Update Changelog
        run: |
          dch --create --package dracut-cryptsetup-duress -v "${{ env.VERSION }}-1" "Automated release from GitHub Actions"
          export DEBIAN_FRONTEND=noninteractive

      - name: Build DEB
        run: |
          dpkg-buildpackage -us -uc -b
          mkdir build_artifacts
          mv ../*.deb build_artifacts/

      - name: Upload DEB Artifact
        uses: actions/upload-artifact@v4
        with:
          name: deb-package
          path: build_artifacts/*.deb

  create-release:
    needs: [build-rpm, build-deb] 
    runs-on: ubuntu-latest
    permissions:
      contents: write 
    steps:
      - uses: actions/download-artifact@v4
        with:
          name: rpm-package
          path: ./assets

      - uses: actions/download-artifact@v4
        with:
          name: deb-package
          path: ./assets

      - name: Create Release
        uses: softprops/action-gh-release@v1
        if: startsWith(github.ref, 'refs/tags/')
        with:
          files: |
            ./assets/*.rpm
            ./assets/*.deb
          body: |
            ## Installation
            
            ### RPM (CentOS/Fedora/RHEL)
            ```bash
            sudo rpm -ivh dracut-cryptsetup-duress-${{ github.ref_name }}.noarch.rpm
            sudo dracut -f
            ```
            
            ### DEB (Debian/Ubuntu/Kali)
            ```bash
            sudo dpkg -i dracut-cryptsetup-duress_${{ github.ref_name }}_all.deb
            sudo update-initramfs -u
            ```
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
